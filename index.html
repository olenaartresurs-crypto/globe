<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Globe</title>

  <style>
    html, body { height: 100%; margin: 0; background: #0000; }
    body { overflow: hidden; }

    #wrap{
      width:100%;
      height:100%;
      position:relative;
      border-radius:24px;
      overflow:hidden;
      background: radial-gradient(circle at 50% 45%, rgba(150,200,255,.18), rgba(0,0,0,0) 55%);
    }

    #globe{ width:100%; height:100%; }

    #tip{
      position:absolute;
      display:none;
      pointer-events:none;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(0,0,0,.70);
      color:#fff;
      font: 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      transform: translate(12px, 12px);
      z-index: 20;
      white-space:nowrap;
      max-width:70%;
      overflow:hidden;
      text-overflow:ellipsis;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }

    #debug{
      position:absolute;
      left:14px;
      top:14px;
      z-index: 30;
      padding:8px 10px;
      border-radius:10px;
      background: rgba(0,0,0,.45);
      color:#fff;
      font: 12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      max-width: 92%;
      backdrop-filter: blur(10px);
    }

    #panel{
      position:absolute;
      left:16px;
      bottom:16px;
      z-index: 25;
      display:none;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(0,0,0,.55);
      color:#fff;
      font: 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      max-width: 92%;
    }
    #panel .name{
      font-weight:800;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    #panel a{
      text-decoration:none;
      font-weight:900;
      font-size:12px;
      color:#000;
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      flex: 0 0 auto;
    }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="globe"></div>
    <div id="tip"></div>
    <div id="debug">Loading…</div>

    <div id="panel">
      <div style="min-width:0">
        <div class="name" id="panelName">Country</div>
        <div style="opacity:.85">Open Notion gallery</div>
      </div>
      <a id="panelBtn" href="#" target="_parent" rel="noopener">Open</a>
    </div>
  </div>

  <!-- libs (UMD) -->
  <script src="https://unpkg.com/three/build/three.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.33.0/dist/globe.gl.min.js"></script>

  <script>
    // ====== 1) Notion links (English country names) ======
    const NOTION_BY_COUNTRY = {
      "Belgium": "https://military-painter-794.notion.site/Belgium-30384bc36d3380f3b2dec9f10b74c5d3"
      // "Poland": "https://...."
    };

    // ====== DOM ======
    const el = document.getElementById("globe");
    const tip = document.getElementById("tip");
    const debug = document.getElementById("debug");
    const panel = document.getElementById("panel");
    const panelName = document.getElementById("panelName");
    const panelBtn = document.getElementById("panelBtn");

    // Tooltip follow mouse
    el.addEventListener("mousemove", (e) => {
      const r = el.getBoundingClientRect();
      tip.style.left = (e.clientX - r.left) + "px";
      tip.style.top  = (e.clientY - r.top) + "px";
    });

    function setDebug(s){ debug.textContent = s; }

    // ====== 2) Create Globe (REALISTIC + BRIGHTER) ======
    const globe = Globe()(el)
      .backgroundColor("rgba(0,0,0,0)")
      // Реалістична земля з океанами
      .globeImageUrl("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
      .bumpImageUrl("https://unpkg.com/three-globe/example/img/earth-topology.png")
      .showAtmosphere(true)
      .atmosphereColor("rgba(120,190,255,0.35)")
      .atmosphereAltitude(0.22);

    // Make it sharper / nicer
    const renderer = globe.renderer();
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));

    // Improve lighting (бо в тебе “темний”)
    const scene = globe.scene();
    scene.add(new THREE.AmbientLight(0xffffff, 1.10));
    const key = new THREE.DirectionalLight(0xffffff, 1.25);
    key.position.set(1.5, 1.0, 1.5);
    scene.add(key);
    const fill = new THREE.DirectionalLight(0xffffff, 0.65);
    fill.position.set(-1.5, -0.6, -1.2);
    scene.add(fill);

    // Ocean shine / detail
    const mat = globe.globeMaterial();
    mat.bumpScale = 7;
    mat.shininess = 22;
    mat.emissive = new THREE.Color(0x223344);
    mat.emissiveIntensity = 0.35;

    // Controls
    const controls = globe.controls();
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.35;
    el.style.cursor = "grab";

    // Start view (Europe-ish)
    globe.pointOfView({ lat: 25, lng: 10, altitude: 2.05 }, 0);

    // ====== 3) Load countries with names ======
    async function loadNameMap(){
      // TSV: id \t name
      const tsvUrl = "https://unpkg.com/world-atlas@2/countries-110m.tsv";
      const tsv = await fetch(tsvUrl, { cache: "no-store" }).then(r => r.text());
      const map = new Map();
      const lines = tsv.split("\n");
      for (let i = 1; i < lines.length; i++){
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split("\t");
        const id = parts[0];
        const name = parts.slice(1).join("\t");
        if (id && name) map.set(String(id), name);
      }
      return map;
    }

    // centroid from bbox (fast)
    function centroidFromBBox(featureObj){
      let minLat =  90, maxLat = -90;
      let minLng = 180, maxLng = -180;

      function walk(coords){
        if (!Array.isArray(coords)) return;
        if (typeof coords[0] === "number" && typeof coords[1] === "number") {
          const lng = coords[0], lat = coords[1];
          minLat = Math.min(minLat, lat);
          maxLat = Math.max(maxLat, lat);
          minLng = Math.min(minLng, lng);
          maxLng = Math.max(maxLng, lng);
        } else {
          for (const c of coords) walk(c);
        }
      }
      walk(featureObj.geometry.coordinates);

      // dateline rough fix
      if (maxLng - minLng > 300) { minLng = -180; maxLng = 180; }

      return { lat: (minLat + maxLat) / 2, lng: (minLng + maxLng) / 2 };
    }

    let hovered = null;
    let selected = null;

    (async () => {
      try{
        setDebug("Loading countries…");

        const [world, nameById] = await Promise.all([
          fetch("https://unpkg.com/world-atlas@2/countries-110m.json", { cache: "no-store" }).then(r => r.json()),
          loadNameMap()
        ]);

        const countries = topojson.feature(world, world.objects.countries).features;

        // Attach English names
        for (const c of countries){
          c.properties = c.properties || {};
          c.properties.name = nameById.get(String(c.id)) || c.properties.name || String(c.id);
        }

        // ====== 4) STYLE: REALISTIC EARTH + 3D COUNTRIES ======
        globe
          .polygonsData(countries)

          // Обʼєм: базова висота + hover + click
          .polygonAltitude(d => (d === selected ? 0.20 : d === hovered ? 0.14 : 0.08))

          // Верх країни — “скло”, щоб земля читалась
          .polygonCapColor(d => (d === selected
            ? "rgba(255,255,255,0.42)"
            : d === hovered
              ? "rgba(255,255,255,0.34)"
              : "rgba(255,255,255,0.18)"
          ))

          // Боковини — темніші, дають “плитку”
          .polygonSideColor(d => (d === selected
            ? "rgba(0,0,0,0.38)"
            : d === hovered
              ? "rgba(0,0,0,0.34)"
              : "rgba(0,0,0,0.22)"
          ))

          // Кордони — щоб реально було “розділено”
          .polygonStrokeColor(() => "rgba(255,255,255,0.55)")
          .polygonsTransitionDuration(180);

        // Hover = піднялась + tooltip + cursor pointer
        globe.onPolygonHover(d => {
          hovered = d || null;
          globe.polygonsData(globe.polygonsData());

          if (d) {
            const name = d.properties.name || "Country";
            tip.textContent = name;
            tip.style.display = "block";
            el.style.cursor = "pointer";
          } else {
            tip.style.display = "none";
            el.style.cursor = "grab";
          }
        });

        // Click = zoom + open Notion (if exists)
        globe.onPolygonClick(d => {
          if (!d) return;

          selected = d;
          globe.polygonsData(globe.polygonsData());

          const name = d.properties.name || "Country";
          const url = NOTION_BY_COUNTRY[name];

          // zoom to country
          const { lat, lng } = centroidFromBBox(d);
          globe.pointOfView({ lat, lng, altitude: 1.18 }, 650);

          // panel
          panelName.textContent = name;
          panel.style.display = "flex";
          panelBtn.href = url || "#";

          // якщо є url — одразу відкриваємо (щоб “клікнув і полетів”)
          if (url) window.parent.location.href = url;
        });

        // Hide panel when click empty area (optional)
        el.addEventListener("click", (e) => {
          if (panel.contains(e.target)) return;
          setTimeout(() => { if (!hovered) panel.style.display = "none"; }, 0);
        });

        setDebug(`OK ✅ Countries loaded: ${countries.length}. Hover a country.`);
        // optionally hide debug after 4s:
        setTimeout(() => { debug.style.display = "none"; }, 4000);

      } catch(err){
        console.error(err);
        setDebug("ERROR ❌ Countries failed to load. Open DevTools Console (F12) and screenshot error.");
      }
    })();

    // Resize handling
    window.addEventListener("resize", () => {
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    });
  </script>
</body>
</html>
