<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Globe</title>
  <style>
    html, body { height:100%; margin:0; background:transparent; }
    body { overflow:hidden; }
    #wrap{
      width:100%; height:100%; position:relative;
      border-radius:24px; overflow:hidden;
      background: radial-gradient(circle at 50% 45%, rgba(150,200,255,.22), rgba(0,0,0,0) 55%);
    }
    #globe{ width:100%; height:100%; }
    #hud{
      position:absolute; left:14px; top:14px; z-index:50;
      padding:8px 10px; border-radius:10px;
      background:rgba(0,0,0,.45); color:#fff;
      font:12px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      backdrop-filter: blur(10px);
      max-width: 92%;
    }
    #tip{
      position:absolute; z-index:60; display:none; pointer-events:none;
      padding:8px 10px; border-radius:10px;
      background:rgba(0,0,0,.70); color:#fff;
      font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      transform: translate(12px, 12px);
      white-space:nowrap;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="globe"></div>
    <div id="hud">Loading…</div>
    <div id="tip"></div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.33.0/dist/globe.gl.min.js"></script>

  <script>

fetch("./countries-110m.json")
  .then(r => r.json())
  .then(world => {
    console.log("COUNTRIES LOADED OK", world);
    window.COUNTRIES_DATA = world;
  })
  .catch(err => {
    console.error("FAILED TO LOAD COUNTRIES", err);
  });

  // === твої Notion посилання ===
  const NOTION_BY_COUNTRY = {
    "Belgium": "https://military-painter-794.notion.site/Belgium-30384bc36d3380f3b2dec9f10b74c5d3"
  };

    // === твої Notion посилання ===
    const NOTION_BY_COUNTRY = {
      "Belgium": "https://military-painter-794.notion.site/Belgium-30384bc36d3380f3b2dec9f10b74c5d3"
    };

    const el  = document.getElementById("globe");
    const hud = document.getElementById("hud");
    const tip = document.getElementById("tip");

    function setHUD(s){ hud.textContent = s; }

    // === Globe ===
    const globe = Globe()(el)
      .backgroundColor("rgba(0,0,0,0)")
      .globeImageUrl("https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg")
      .bumpImageUrl("https://unpkg.com/three-globe/example/img/earth-topology.png")
      .showAtmosphere(true)
      .atmosphereColor("rgba(120,190,255,0.35)")
      .atmosphereAltitude(0.22);

    // renderer/canvas
    const renderer = globe.renderer();
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    const canvas = renderer.domElement;          // ВАЖЛИВО: курсор/миш = тут

    // світло, щоб не було “темний”
    const scene = globe.scene();
    scene.add(new THREE.AmbientLight(0xffffff, 1.15));
    const key = new THREE.DirectionalLight(0xffffff, 1.35);
    key.position.set(2.0, 1.2, 1.8);
    scene.add(key);
    const fill = new THREE.DirectionalLight(0xffffff, 0.70);
    fill.position.set(-1.6, -0.8, -1.2);
    scene.add(fill);

    // матеріал “океан красивіше”
    const mat = globe.globeMaterial();
    mat.bumpScale = 7;
    mat.shininess = 28;
    mat.emissive = new THREE.Color(0x223344);
    mat.emissiveIntensity = 0.32;

    // контрол
    const controls = globe.controls();
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.35;

    globe.pointOfView({ lat: 25, lng: 10, altitude: 2.05 }, 0);
    canvas.style.cursor = "grab";

    // tooltip follow (по canvas!)
    canvas.addEventListener("mousemove", (e) => {
      const r = el.getBoundingClientRect();
      tip.style.left = (e.clientX - r.left) + "px";
      tip.style.top  = (e.clientY - r.top) + "px";
    });

    // === names map: id -> name (world-atlas tsv) ===
    async function loadNameMap(){
      const tsv = await fetch("https://unpkg.com/world-atlas@2/countries-110m.tsv", { cache:"no-store" })
        .then(r => r.text());
      const map = new Map();
      const lines = tsv.split("\n");
      for (let i=1;i<lines.length;i++){
        const line = lines[i].trim();
        if (!line) continue;
        const [id, ...rest] = line.split("\t");
        const name = rest.join("\t");
        if (id && name) map.set(String(id), name);
      }
      return map;
    }

    function centroidFromBBox(feature){
      let minLat= 90, maxLat=-90, minLng=180, maxLng=-180;
      (function walk(c){
        if (!Array.isArray(c)) return;
        if (typeof c[0]==="number" && typeof c[1]==="number"){
          const lng=c[0], lat=c[1];
          minLat=Math.min(minLat,lat); maxLat=Math.max(maxLat,lat);
          minLng=Math.min(minLng,lng); maxLng=Math.max(maxLng,lng);
        } else c.forEach(walk);
      })(feature.geometry.coordinates);

      if (maxLng - minLng > 300) { minLng=-180; maxLng=180; }
      return { lat:(minLat+maxLat)/2, lng:(minLng+maxLng)/2 };
    }

    let hovered=null, selected=null;
    let countriesCount=0;

    (async () => {
      try{
        setHUD("Loading countries…");

        const [world, nameById] = await Promise.all([
          fetch("https://unpkg.com/world-atlas@2/countries-110m.json", { cache:"no-store" }).then(r => r.json()),
          loadNameMap()
        ]);

        const countries = topojson.feature(world, world.objects.countries).features;
        countries.forEach(c => {
          c.properties = c.properties || {};
          c.properties.name = nameById.get(String(c.id)) || c.properties.name || String(c.id);
        });
        countriesCount = countries.length;

        // СТИЛЬ КРАЇН: щоб було видно 100%
        globe.polygonsData(countries)
          .polygonAltitude(d => (d===selected ? 0.22 : d===hovered ? 0.16 : 0.09))
          .polygonCapColor(d => (d===selected
            ? "rgba(255,255,255,0.55)"
            : d===hovered
              ? "rgba(255,255,255,0.45)"
              : "rgba(255,255,255,0.22)"
          ))
          .polygonSideColor(d => (d===selected
            ? "rgba(0,0,0,0.55)"
            : d===hovered
              ? "rgba(0,0,0,0.48)"
              : "rgba(0,0,0,0.30)"
          ))
          // кордони ЯСКРАВІ
          .polygonStrokeColor(d => (d===hovered || d===selected)
            ? "rgba(255,255,255,0.95)"
            : "rgba(255,255,255,0.70)"
          )
          .polygonsTransitionDuration(140);

        // HOVER
        globe.onPolygonHover(d => {
          hovered = d || null;
          globe.polygonsData(globe.polygonsData()); // trigger rerender

          if (d){
            const name = d.properties.name || "Country";
            tip.textContent = name;
            tip.style.display = "block";
            canvas.style.cursor = "pointer";
            setHUD(`Countries: ${countriesCount} | Hover: ${name}`);
          } else {
            tip.style.display = "none";
            canvas.style.cursor = "grab";
            setHUD(`Countries: ${countriesCount} | Hover: —`);
          }
        });

        // CLICK -> NOTION
        globe.onPolygonClick(d => {
          if (!d) return;
          selected = d;
          globe.polygonsData(globe.polygonsData());

          const name = d.properties.name || "Country";
          const url = NOTION_BY_COUNTRY[name];

          const {lat,lng} = centroidFromBBox(d);
          globe.pointOfView({ lat, lng, altitude: 1.18 }, 650);

          if (url) window.parent.location.href = url;
          else setHUD(`No Notion link for: ${name} (add to NOTION_BY_COUNTRY)`);
        });

        setHUD(`Countries: ${countriesCount} | Hover: —`);
      } catch (e){
        console.error(e);
        setHUD("ERROR loading countries. Press F12 → Console and screenshot.");
      }
    })();

    window.addEventListener("resize", () => {
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    });
  </script>
</body>
</html>
